logsBucket: 'gs://bucket67ut'

steps:
# Build and push Apache image
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'us-central1-docker.pkg.dev/sukrit-singh-426716/my-repo/apache:v1', './apache']
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'us-central1-docker.pkg.dev/sukrit-singh-426716/my-repo/apache:v2']

# Build and push Tomcat image
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'us-central1-docker.pkg.dev/sukrit-singh-426716/my-repo/tomcat:v1', './tomcat']
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'us-central1-docker.pkg.dev/sukrit-singh-426716/my-repo/tomcat:v1']

# Create instance templates
- name: 'gcr.io/cloud-builders/gcloud'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    gcloud compute instance-templates create-with-container apache-template-v1 \
      --container-image us-central1-docker.pkg.dev/sukrit-singh-426716/my-repo/apache:v1 \
      --tags=http-server \
      --machine-type=e2-medium \
      --network=my-app-network
     

    gcloud compute instance-templates create-with-container tomcat-template-v1 \
      --container-image us-central1-docker.pkg.dev/sukrit-singh-426716/my-repo/tomcat:v1 \
      --tags=app-server \
      --machine-type=e2-medium \
      --network=my-app-network
  

# Update Managed Instance Groups
- name: 'gcr.io/cloud-builders/gcloud'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    gcloud compute instance-groups managed rolling-action start-update apache-mig \
      --version template=apache-template-v1 \
      --max-surge=1 \
      --max-unavailable=1 \
      --zone=us-central1-a

    gcloud compute instance-groups managed rolling-action start-update tomcat-mig \
      --version template=tomcat-template-v1 \
      --max-surge=1 \
      --max-unavailable=1 \
      --zone=us-central1-a

images:
- 'us-central1-docker.pkg.dev/sukrit-singh-426716/my-repo/apache:v1'
- 'us-central1-docker.pkg.dev/sukrit-singh-426716/my-repo/tomcat:v1'
